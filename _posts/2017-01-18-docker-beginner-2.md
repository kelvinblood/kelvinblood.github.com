---
layout: post
title: Docker 新手上路（二）——Dockerfile
category: tech
tags: docker devops tutorial
---

![](https://cdn.kelu.org/blog/tags/docker.jpg)
今天的好玩新闻有这几件事：

* 英国梅姨一声硬脱欧，英镑兑美元涨了将近2.6%
* 支付宝又搞起了敬业福，冠华是五福红包的产品经理。
* 甲骨文北京裁员2000人。
* 最近火起来一句话，“我可能是x假的x”。
* 一位微信陌生好友给我推荐了一个专门收集互联网大会的[网站][huodongjia]

前几天新学习了 [docker][docker_gitbook] 的基本知识，包括安装、环境配置、获取和运行镜像等最基础的东西。今天学习一些 docker 的启动查看定制等操作。

镜像的定制实际上就是定制每一层所添加的配置、文件。如果我们可以把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么之前提及的无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决。这个脚本就是 Dockerfile。
用过 PHP Laravel 框架的应该马上就理解了（其他例如java kotlin等也是类似），这个就和 composer.json 脚本一样，用来保证环境一致性的配置文件。

定制镜像需要用到下面几个命令

* FROM 指定基础镜像
* RUN 执行命令
* BUILD 构建镜像

Dockerfile 正确的写法应该是这样：

    FROM xxx

    RUN buildDeps='gcc libc6-dev make' \
        && apt-get update \
        && apt-get install -y $buildDeps \
        && wget -O redis.tar.gz "http://download.redis.io/releases/redis-3.2.5.tar.gz" \
        && mkdir -p /usr/src/redis \
        && tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \
        && make -C /usr/src/redis \
        && make -C /usr/src/redis install \
        && rm -rf /var/lib/apt/lists/* \
        && rm redis.tar.gz \
        && rm -r /usr/src/redis \
        && apt-get purge -y --auto-remove $buildDeps

然后在该目录执行

    $ docker build -t nginx:v3 .
    
使用 docker build 命令进行镜像构建。其格式为：
    
    docker build [选项] <上下文路径/URL/->
    
    #build
          --no-cache=false Do not use cache when building the image
          -q, --quiet=false Suppress the verbose output generated by the containers
          --rm=true Remove intermediate containers after a successful build
          -t, --tag="" Repository name (and optionally a tag) to be applied to the resulting image in case of success
          
    docker build -t image_name Dockerfile_path
    
    
    
在这里我们指定了最终镜像的名称 -t nginx:v3。
一般大家习惯性的会使用默认的文件名 Dockerfile，以及会将其置于镜像构建上下文目录中。

# Docker Build 的用法

* Dockerfile  `docker build -t nginx:v3 .`
* Git repo    `docker build https://github.com/twang2218/gitlab-ce-zh.git#:8.14`
* tar 压缩包  `docker build http://server/context.tar.gz`
* 标准输入中读取 Dockerfile

        docker build - < Dockerfile
        cat Dockerfile | docker build -

* 标准输入中读取上下文压缩包 `docker build - < context.tar.gz`

# Dockerfile

Dockerfile是自动构建docker镜像的配置文件，Dockerfile中的命令非常类似linux shell下的命令，支持以 # 开头的注释行.一般，Dockerfile分为4部分

* 基础镜像（父镜像）信息
* 维护者信息
* 镜像操作命令
* 容器启动命令

![](https://cdn.kelu.org/blog/2017/01/Docker-commoand.png)

下面是一个CentOS7的Dockerfile实例

    FROM       daocloud.io/centos:7
    MAINTAINER hanxt <hanxiaotongtong@163.com>

    ENV TZ "Asia/Shanghai"
    ENV TERM xterm


    ADD aliyun-mirror.repo /etc/yum.repos.d/CentOS-Base.repo
    ADD aliyun-epel.repo /etc/yum.repos.d/epel.repo



    RUN yum install -y curl wget tar bzip2 unzip vim-enhanced passwd sudo yum-utils hostname net-tools rsync man && \
        yum install -y gcc gcc-c++ git make automake cmake patch logrotate python-devel libpng-devel libjpeg-devel && \
        yum install -y --enablerepo=epel pwgen python-pip && \
        yum clean all



    RUN pip install supervisor
    ADD supervisord.conf /etc/supervisord.conf

    RUN mkdir -p /etc/supervisor.conf.d && \
        mkdir -p /var/log/supervisor

    EXPOSE 22

    ENTRYPOINT ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisord.conf"]

### 详细解析

    FROM daocloud.io/centos:7
    # 基于父镜像构建其他docker镜像，父镜像：可以通过docker pull 命令获得，也可以自己制作
    
    MAINTAINER hanxt <hanxiaotongtong@163.com>
    # Dockerfile维护者

    ENV TZ "Asia/Shanghai"
    # ENV（environment）设置环境变量，一个Dockerfile中可以写多个。以上例子是：设置docker容器的时区为Shanghai
    
    # Dockerfile中有2条指令可以拷贝文件
    
    ADD aliyun-mirror.repo /etc/yum.repos.d/CentOS-Base.repo
    # 拷贝本地文件到docker容器里，还可以拷贝URL链接地址下的文件，ADD还具有解压软件包的功能(支持gzip, bzip2 or xz)
    
    COPY test /mydir
    # 拷贝本地文件到docker容器
    
    
    安装linux软件包
    RUN yum install -y curl wget....

    # RUN命令，非常类似linux下的shell命令 (the command is run in a shell – /bin/sh -c – shell form)
    在Dockerfile中每执行一条指令（ENV、ADD、RUN等命令），都会生成一个docker image layer
    RUN pip install supervisor

    # 安装supervisor进程管理系统，推荐使用
    ADD supervisord.conf /etc/supervisord.conf

    # 添加supervisor的主配置文件，到docker容器里
    RUN mkdir -p /etc/supervisor.conf.d

    # 创建存放启动其他服务”supervisor.conf”的目录，此目录下的所有以.conf结尾的文件，在启动docker容器的时候会被加载
    端口映射
    EXPOSE 22

    # 端口映射 EXPOSE <host_port>:<container_port>
    # 推荐使用docker run -p <host_port>:<container_port>来固化端口
    # 容器启动时执行的命令 ENTRYPOINT [“/usr/bin/supervisord”, “-n”, “-c”, “/etc/supervisord.conf”]
    # 一个Dockerfile中只有最后一条ENTRYPOINT生效，并且每次启动docker容器，都会执行ENTRYPOINT

参考资料：

* [Dockerfie 官方文档](https://docs.docker.com/engine/reference/builder/)
* [Dockerfile 最佳实践文档](https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/)
* [DockerFile简介与实例](http://www.zimug.com/308.html)
* [Dockerfiles最佳实践经验](http://www.zioer.org/2016/05/29/docker-engine-Best-practices-Dockerfiles/)

[docker_gitbook]: https://www.gitbook.com/book/yeasy/docker_practice
[select_a_docker_storage_driver]: https://www.centos.bz/2016/12/select-a-docker-storage-driver
[docker_hub]: https://hub.docker.com
[docker_store]: https://store.docker.com
[huodongjia]: http://www.huodongjia.com/it/
